name: Auto-Update Copilot Collections
on:
  workflow_call:
    inputs:
      config_file:
        description: "Path to configuration file"
        default: ".copilot-collections.yaml"
        type: string

permissions: {}

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Consumer Repo
        uses: actions/checkout@v6.0.1
        with:
          persist-credentials: false

      - name: Get Target Version
        id: config
        env:
          CONFIG_FILE: ${{ inputs.config_file }}
        run: |
          # Install yq if not available
          if ! command -v yq &> /dev/null; then
            sudo snap install yq
          fi
          CURRENT_VERSION=$(yq '.copilot.version' "$CONFIG_FILE")
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Check Latest Toolkit Release
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_VERSION: ${{ steps.config.outputs.CURRENT_VERSION }}
        run: |
          LATEST=$(gh release view --repo canonical/copilot-collections --json tagName --jq .tagName)
          
          # Compare LATEST vs CURRENT
          if [ "$LATEST" == "$CURRENT_VERSION" ]; then
            echo "UPDATE_NEEDED=false" >> $GITHUB_OUTPUT
          else
            echo "UPDATE_NEEDED=true" >> $GITHUB_OUTPUT
            echo "LATEST_VERSION=$LATEST" >> $GITHUB_OUTPUT
          fi

      - name: Checkout Toolkit
        if: steps.upstream.outputs.UPDATE_NEEDED == 'true'
        uses: actions/checkout@v6.0.1
        with:
          repository: canonical/copilot-collections
          ref: ${{ steps.upstream.outputs.LATEST_VERSION }}
          path: toolkit-temp
          persist-credentials: false

      - name: Run Update Script
        if: steps.upstream.outputs.UPDATE_NEEDED == 'true'
        env:
          LATEST_VERSION: ${{ steps.upstream.outputs.LATEST_VERSION }}
          CONFIG_FILE: ${{ inputs.config_file }}
        run: |
          yq -i ".copilot.version = \"$LATEST_VERSION\"" "$CONFIG_FILE"

          chmod +x toolkit-temp/scripts/install_collections.sh
          ./toolkit-temp/scripts/install_collections.sh \
            "$CONFIG_FILE" \
            "toolkit-temp"

          rm -rf toolkit-temp

      - name: Create Pull Request
        if: steps.upstream.outputs.UPDATE_NEEDED == 'true'
        uses: canonical/create-pull-request@6b53f317c9556693d19beaa5651cb8c8843809e5 # v1.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Copilot collections to ${{ steps.upstream.outputs.LATEST_VERSION }}"
          branch-name: "chore/auto-copilot-collections"
          title: "chore: update Copilot collections to ${{ steps.upstream.outputs.LATEST_VERSION }}"
          body: "Update to version `${{ steps.upstream.outputs.LATEST_VERSION }}`."
          upsert: true
          ignore-no-changes: true
